<% # app/views/gw/public/schedules/_show_day.html.erb
wdays = ["日", "月", "火", "水", "木", "金", "土"]
d = @st_date # 初期化処理
@link_format = "%Y%m%d"

@view = "day"
uid = Site.user.id
@dis = nz(params[:dis],'week')
link_params = "?gid=#{params[:gid]}&uid=#{uid}&cgid=#{params[:cgid]}&dis=#{@dis}"
# テーブル文 追加 matsuki 100420 end
items_all = {}
header_str = ""
show_flg = true

case @sp_mode
when :schedule
#  header_str += render(:partial => '/gw/public/schedules/header')
#  concat render(:partial => '/gw/public/schedules/header')

#  uids = Gw::Model::Schedule.get_uids(params)
#  uids.each{|x| items_all[x] = Gw::Model::Schedule.select_my_data(d, d, x).select{|x| x[:genre] != :holiday}}
  users = @users ? @users :  Gw::Model::Schedule.get_users(params)
  users.each{|x| items_all[x.id] = Gw::Model::Schedule.select_my_data(d, d, x.id , {:user => x, :is_pm_admin => @is_pm_admin, :is_gw_admin => @is_gw_admin}).select{|x| x[:genre] != :holiday}}

  # note/100310/nkoshiba: :holiday 除外にしているが終日予定実装後は終日予定を除外するように修正すべき
when :prop
  raise ArgumentError, "呼び出しが不正です" if params[:s_genre].blank?
#  header_str += render(:partial => '/gw/public/schedule_props/header')
#  header_str += render(:partial => '/gw/public/schedule_props/header_view')
#  header_str += '<span style="color: red;" class="att">'
#  header_str += link_to '必ず注意事項をご覧ください。', "/gwbbs/docs/6/?title_id=38", :target=>:_blank if @genre == "rentcar"
#  header_str += link_to '必ず注意事項をご覧ください。', "/gwbbs/docs/3/?title_id=38", :target=>:_blank if @genre == "meetingroom"
#  header_str += '</span>'

#  concat render(:partial => '/gw/public/schedule_props/header')
#  concat render(:partial => '/gw/public/schedule_props/header_view')
  #uids = Gw::Model::Schedule.get_prop_ids(params)
  #uids.each{|x| items_all[x] = Gw::Model::Schedule.select_prop_data(d, d, x, params)}
  props = Gw::Model::Schedule.get_props(params, @is_pm_admin, @is_gw_admin, {:s_other_admin_gid=>@s_other_admin_gid})
  show_flg = false if props.length == 0
  if !params[:prop_id].blank?
    _mdl = Gw::Model::Schedule.get_prop_model(params)
    prop = _mdl.find_by_id(params[:prop_id])
    show_flg = (prop.delete_state == 0 || props.length != 0) ? true : false
    if show_flg && @genre == 'other' && !@is_gw_admin
      if !Gw::PropOtherRole.is_edit?(params[:prop_id]) && !Gw::PropOtherRole.is_read?(params[:prop_id])
        show_flg = false
      end
    end
  end
  props.each{|x| items_all[x.id] = Gw::Model::Schedule.select_prop_data(d, d, x.id, params, {:is_pm_admin => @is_pm_admin, :is_gw_admin => @is_gw_admin, :sp_mode => @sp_mode, :s_genre => params[:s_genre]})}
end
items = items_all
%>
<div class="pieceBodyBody"><table summary="スケジュール詳細" class="scheduleTable">
<tr><th class="date">
<%=d.strftime('%Y年%m月%d日') unless d.blank?%>(<%=wdays[d.wday] unless d.blank?%>)
</th><th class="new">
<%=link_to(image_tag('/_common/themes/gw/files/smartphone/other/ic_add.gif', { :border => '0', :alt => '新規作成', :title => '新規作成', :class=>'menu_new'}),
   %Q(/gw/schedules/new?s_date=#{(d).strftime('%Y%m%d')}#{link_params}&topdate=#{@topdate})) unless d.blank?%>
</th></tr>
<%for user in users%>
  <%if items[user.id].blank?%>
<%= %Q(<tr><td colspan="2">予定なし</td></tr>) if (params[:gid].blank? && params[:cgid].blank?) %>
  <%else%>
    <%= %Q(<tr><td class="user" colspan="2">#{user.name}(#{user.code})</td></tr>) if ((!params[:gid].blank? || !params[:cgid].blank?) && !items[user.id].blank? )%>
    <% for item in items[user.id]%>
<tr>
<td class="<%=item[:class]%>" colspan="2">
<%if item[:allday].to_i==1
  lnk_time_str = "時間未定"
elsif item[:allday].to_i==2
  lnk_time_str = "終日"
else
  lnk_time_str = item[:time_str]
end%>
    <%if item[:title_raw] == "[非公開予定]"%>
    <span style="color: #999999;"><%= item[:title_raw] -%></span>
    <%else
      title_raw = %Q(#{lnk_time_str}<br />#{item[:title_raw]})
     %>
        <%= link_to title_raw ,%Q(#{item[:title_link].to_s}#{link_params}&topdate=#{@topdate}) -%>
    <%end%>

</td>
</tr>
    <%end%>
  <%end%>
<%end%>
</table>

