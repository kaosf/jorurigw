<%
d = @st_date
@link_format = "%Y%m%d"

@view = "day"
uid = Site.user.id
@dis = nz(params[:dis],'week')
link_params = "?gid=#{params[:gid]}&uid=#{uid}&cgid=#{params[:cgid]}&dis=#{@dis}"

items_all = {}
header_str = ""
show_flg = true

case @sp_mode
when :schedule

  users = @users ? @users :  Gw::Model::Schedule.get_users(params)
  users.each{|x| items_all[x.id] = Gw::Model::Schedule.select_my_data(d, d, x.id , {:user => x, :is_gw_admin => @is_gw_admin}).select{|x| x[:genre] != :holiday}}

when :prop

  raise ArgumentError, "呼び出しが不正です" if params[:s_genre].blank?
  props = Gw::Model::Schedule.get_props(params, @is_gw_admin, {:s_other_admin_gid=>@s_other_admin_gid})
  show_flg = false if props.length == 0
  if !params[:prop_id].blank?
    _mdl = Gw::Model::Schedule.get_prop_model(params)
    prop = _mdl.find_by_id(params[:prop_id])
    show_flg = (prop.delete_state == 0 || props.length != 0) ? true : false
    if show_flg && @genre == 'other' && !@is_gw_admin
      if !Gw::PropOtherRole.is_edit?(params[:prop_id]) && !Gw::PropOtherRole.is_read?(params[:prop_id])
        show_flg = false
      end
    end
  end
  props.each{|x| items_all[x.id] = Gw::Model::Schedule.select_prop_data(d, d, x.id, params, {:is_gw_admin => @is_gw_admin, :sp_mode => @sp_mode, :s_genre => params[:s_genre]})}

end
items = items_all
%>
<p class="leftPad2"><%=link_to("前日", %Q(/gw/schedules/#{date_format(@link_format, d-1)}#{link_params})) -%>|
<%=link_to("翌日", %Q(/gw/schedules/#{date_format(@link_format, d+1)}#{link_params})) -%>
</p>
<%for user in users%>
  <%if items[user.id].blank?%>
<%= %Q(<p class="leftPad1">予定なし</p>) if (params[:gid].blank? && params[:cgid].blank?) %>
  <%else%>
    <%= %Q(#{user.name}(#{user.code})<br />) if ((!params[:gid].blank? || !params[:cgid].blank?) && !items[user.id].blank? )%>
    <% for item in items[user.id]%>
<div class="<%=item[:class]%>">
<p class="leftPad1">
       <%if item[:allday].to_i==1%>
  時間未定<br />
       <%elsif item[:allday].to_i==2%>
  終日<br />
       <%else%>
  <%=h item[:time_str]%><br />
       <%end%>
</p>
  <p class="leftPad1">
    <%if item[:title_raw] == "[非公開予定]"%>
    &nbsp;&nbsp;<span style="color: #999999;"><%= item[:title_raw] -%></span>
    <%else%>
    &nbsp;&nbsp;<%= link_to  h(item[:title_raw]) ,%Q(#{item[:title_link].to_s}#{link_params}&topdate=#{@topdate}) -%>
    <%end%>
  </p>
</div>
    <%end%>
  <%end%>
<%end%>
<p class="leftPad2"><%=link_to("前日", %Q(/gw/schedules/#{date_format(@link_format, d-1)}#{link_params})) -%>|
<%=link_to("翌日", %Q(/gw/schedules/#{date_format(@link_format, d+1)}#{link_params})) -%>
</p>


